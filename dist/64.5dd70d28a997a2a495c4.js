(self.webpackChunkrm_frontend=self.webpackChunkrm_frontend||[]).push([[64],{1473:function(e,t,i){"use strict";i.r(t);var a=i(312),n=i(336),s=i.n(n),r=i(321),o=i(1123),m=i(1433),g=i(339),d=i(323),u=i(308),h=i(1355),c=i(1438),l=i(1383),f=i(1457);function w(e,t,i,a,n,s,r){try{var o=e[s](r),m=o.value}catch(e){return void i(e)}o.done?t(m):Promise.resolve(m).then(a,n)}function p(e){return function(){var t=this,i=arguments;return new Promise((function(a,n){var s=e.apply(t,i);function r(e){w(s,a,n,r,o,"next",e)}function o(e){w(s,a,n,r,o,"throw",e)}r(void 0)}))}}var v,M,P,R,D,_,y=s().Router.extend({routes:{":user/:mag/num/:pageNum/":"startByPageNum",":user(/)(:mag)(/)(*pageUri)(/)":"start"},mags:{},initialize:function(){var e=this;if(f.ZP.setTiming(f.qK.DomLoaded,window.performance.timing.domLoading),f.ZP.setTiming(f.qK.ScriptsLoaded,window.performance.timing.domContentLoadedEventEnd),f.ZP.setTiming(f.qK.RouterInit,Date.now()),RM.common.isDomainViewer&&(RM.common.customDomainProfile?this.route(":mag(/)(*pageUri)(/)","start"):this.route("(*pageUri)(/)","start")),RM.common.isDownloadedSource&&(this.route("(*pageUri)(/)","start"),/msie [6-9]/i.test(navigator.userAgent)&&(location.href="sorry.html")),(0,a.ZP)("html").toggleClass("viewer-embed-mode",!!RM.common.embedMode),r.Z.bindAll(this),this.environment=u.Z.environment.viewer,this.started=!1,!RM.common.isDownloadedSource&&window.RM.data.usersLoader.me&&(this.me=window.RM.data.usersLoader.me),this.$mags_container=(0,a.ZP)("#mags"),this.magsData=window.ServerData&&window.ServerData.mags,l.Z.init(window.ServerData&&window.ServerData.userPermissions),this.internalHistory=[],this.magsData){if(this.cachedMag=r.Z.clone(this.magsData.mag),!this.cachedMag||!this.cachedMag.user||!this.cachedMag.user._id)return;RM.common.isDownloadedSource||(this.cachedMag.user.isMe=this.me&&this.me.get("_id")==this.cachedMag.user._id),RM.common.isDomainViewer&&(this.magUri=this.cachedMag.uri,this.userUri=this.cachedMag.user&&this.cachedMag.user.uri)}RM.screenshot||i.e(62).then(i.bind(i,965)).then((function(t){var a,n,s=t.default;RM.analytics=RM.analytics||new s({router:e}),e.analytics=RM.analytics,e.analytics.setCustomDimensions({magId:e.mag&&e.mag.model&&e.mag.model.get("num_id")||e.mag&&e.mag.num_id,magCreatorId:e.mag&&e.mag.model&&e.mag.model.user.get("_id")||e.mag&&e.mag.user._id,pageType:"viewer",userId:e.me&&e.me.get("_id")}),RM.common.isDomainViewer||g.default.processCustomTrackingEventCookies();var r=!0===(null===(a=window.RM)||void 0===a||null===(n=a.common)||void 0===n?void 0:n.isDomainViewer);u.Z.isProd&&!r&&i.e(54).then(i.bind(i,1553)).then((function(e){(0,e.getWebVitals)()}))})),this.isPreview||Modernizr.sessionstorage&&window.sessionStorage.removeItem("constructorViewport")},startByPageNum:function(e,t,i){this.start(e,t,null,i)},getPageUrlFromCodeExportLink:function(e){var t;if(!e)return e;if(null!==(t=window.RM.config)&&void 0!==t&&t.root){var i=window.RM.config.root;return"/"===i[0]&&(i=i.substr(1)),e.replace(i,"")}return e},start:function(e,t,n,o){var g=this;if(RM.common.isDomainViewer&&(this.magsData.magNotFound||this.magsData.domainNotFound||this.magsData.magNotPublished||this.magsData.subscriptionExpired))i.e(63).then(i.bind(i,1459)).then((function(e){new(0,e.default)({type:"domain-error",$container:(0,a.ZP)("#service-pages"),templateData:{state:g.magsData}}).render()}));else if(isNaN(parseInt(o))&&(o=void 0),Modernizr.msie||Modernizr.msie11)i.e(60).then(i.bind(i,963)).then((function(e){new(0,e.default)({$parent:(0,a.ZP)("body > .popups"),router:g,opts:{type:"type-browsers-viewer"}}).render()}));else{if(!o)if(RM.common.isDomainViewer&&!RM.common.customDomainProfile)parseInt(e,10)!=e&&e&&/^p\d+\/?$/i.test(e)?(n=null,t=e,e=null):(n=e,e=this.userUri,t=this.magUri),RM.common.isDownloadedSource&&(n=this.getPageUrlFromCodeExportLink(n));else if(RM.common.isDownloadedSource)n=this.getPageUrlFromCodeExportLink(e),e=null,t=null;else if(parseInt(e,10)==e||/^p\d+\/?$/i.test(e)){var d=t;t=e,n=d,e=null}else if(RM.common.customDomainProfile){d=t;t=e,n=d,e=this.userUri}else if(!t)return this.notFound();this.latestFragment=s().history.getFragment(),n=n||1,o&&(n=o);var u=e+"_"+t;if(this.username=e,this.magname=t,this.started!=u||this.loaded==u)if(this.started=u,this.loaded!==this.started){if(this.cachedMag&&!r.Z.isEmpty(this.cachedMag))return this.cachedMag instanceof m.Z||this.cachedMag.forbidden||this.cachedMag.is_suspended||(this.cachedMag=new m.Z(this.cachedMag,this)),this.mag=this.cachedMag,void this.onPreloadMag(n,!!o);this._loadingMagDataXHR&&this._loadingMagDataXHR.abort(),this._loadingMagDataXHR=this.fetchData(this.username,t,{success:r.Z.bind((function(e){this.mag&&this.mag.num_id&&e&&e.num_id!=this.mag.num_id&&window.location.reload(),this.mag=new m.Z(e,this),this.cachedMag=this.mag,this.onPreloadMag(n,!!o)}),this),error:this.notFound})}else this.go(n,{animation:!1,isPageNum:!!o})}},restartFullMag:(_=p(regeneratorRuntime.mark((function e(t,i){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:d.Z.isDesktop||window.location.reload(),this.started=this.username+"_"+this.magname,this._loadingMagDataXHR&&this._loadingMagDataXHR.abort(),this._loadingMagDataXHR=this.fetchData(this.username,this.magname,{success:r.Z.bind((function(e){this.mag&&this.mag.num_id&&e&&e.num_id!==this.mag.num_id&&window.location.reload(),this.mag=new m.Z(e,this),this.cachedMag=this.mag,this.onPreloadMag(t,i,!0)}),this),error:this.notFound});case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return _.apply(this,arguments)}),restartMag:(D=p(regeneratorRuntime.mark((function e(t){var i,a,n,s,o,g,d=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.currentPage,a=t.refetchOnlyPrivate,s=(n=void 0!==a&&a)?this.mag.pages.filter((function(e){return e.isPasswordProtected()})).map((function(e){return e.num_id})):void 0,e.next=4,this.fetchMagPages(s);case 4:o=e.sent,n&&o?this.mag.pages.forEach((function(e){var t=o.find((function(t){return t._id===e._id}));t&&d.mag.rerenderPage(t,d.magsData.mag)})):o&&(g=r.Z.clone(this.mag.aboveGlobalWidgetsData),this.mag.destroy&&this.mag.destroy(),this.mag=r.Z.clone(this.magsData.mag),this.mag.pages=n?this.mag.pages.map((function(e){var t=o.findIndex((function(t){return e._id===t._id}));return t<0?e:o[t]})):o,this.mag=new m.Z(this.mag,this),this.mag.aboveGlobalWidgetsData=(g||[]).concat(this.mag.aboveGlobalWidgetsData),this.cachedMag=this.mag),this.onPreloadMag(i,!0);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return D.apply(this,arguments)}),fetchMagPages:(R=p(regeneratorRuntime.mark((function e(t){var i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=Array.isArray(t)&&t.length?t.join(","):void 0,this._loadingPagesDataXHR&&this._loadingPagesDataXHR.abort(),this._loadingPagesDataXHR=a.ZP.ajax({url:"/api/magpages/".concat(this.mag.num_id),method:"GET",data:i?{pages:i}:void 0,success:function(e){return e},error:function(){return null},context:this}),e.abrupt("return",this._loadingPagesDataXHR);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return R.apply(this,arguments)}),onPreloadMag:function(e,t){var i,a,n=this,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=null===(i=this.mag.model)||void 0===i||null===(a=i.attributes)||void 0===a?void 0:a.usedWidgetTypes;(0,c.preloadWidgets)(null!=r&&r.length?r:g.default.usedWidgets(this.mag.pages||[],this.mag.aboveGlobalWidgetsData)).finally((function(){n.onLoadMag(e,t,s)}))},onLoadMag:function(e,t){var i,n=this;if(f.ZP.setTiming(f.qK.MagLoaded,Date.now()),this.loaded=this.started||!0,this.mag.forbidden)return this.requestMagPassword(this.latestFragment,r.Z.clone(this.mag),e,t),delete this.cachedMag,delete this.loaded,void delete this.started;if(this.mag.is_suspended)this.showSuspended();else{var s=new Event(u.q.ProjectInitialized,{bubbles:!0});document.dispatchEvent(s),!this.isPreview&&this.mag.hasNewTextWidgets()&&(0,h.IB)("viewer"),RM.common.isDownloadedSource||(a.ZP.post("/api/countview/"+this.mag.num_id),RM.analytics&&(RM.analytics._triggerProjectView=!0)),this.mag._requested_page&&!t?(i=this.mag._requested_page,delete this.mag._requested_page):i=e,Modernizr.addTest("screenshot-mode",(function(){return RM.screenshot})),this.mag.render(),this.go(i,{animation:!1,isPageNum:t});var o=new Event(u.q.ProjectRendered,{bubbles:!0});if(document.dispatchEvent(o),RM.common.mode="mag",this.analytics&&this.analytics.setCustomDimensions({magId:this.mag&&this.mag.model&&this.mag.model.get("num_id")||this.mag&&this.mag.num_id,magCreatorId:this.mag&&this.mag.model&&this.mag.model.user.get("_id")||this.mag&&this.mag.user._id,pageType:"viewer",userId:this.me&&this.me.get("_id")}),!this.isPreview){f.ZP.setTiming(f.qK.MagRendered,Date.now());var m=RM.viewerRouter.mag.currentPage.num;setTimeout((function(){f.ZP.setTiming(f.qK.DomComplete,window.performance.timing.domComplete),f.ZP.sendTimings({projectNumId:n.mag.num_id,userNumId:n.mag.user.num_id,viewport:n.mag.viewport,startPage:m,widgetsCount:r.Z.reduce(RM.viewerRouter.mag.pages,(function(e,t){return e+(t.widgets?t.widgets.length:0)}),0)+n.mag.aboveGlobalWidgets.length})}),1e4)}}},getAnalyticsDimensions:function(){return{magId:this.mag&&this.mag.model&&this.mag.model.get("num_id")||this.mag&&this.mag.num_id,magCreatorId:this.mag&&this.mag.model&&this.mag.model.user.get("_id")||this.mag&&this.mag.user._id,pageType:"viewer",userId:this.me&&this.me.get("_id")}},fetchData:function(e,t,i){return(i=i||{}).url=e?"/api/readymag/"+e+"/"+t:"/api/readymag/"+t,a.ZP.ajax(i)},sendReadyEvent:function(e){if(e=e||{},e=r.Z.defaults(e,{page:{}}),window.loadNotifier){if(e.error)return window.loadNotifier({error:e.error});window.loadNotifier({width:e.page.width,height:e.page.height})}},setTitle:function(){if(this.mag&&this.mag.currentPage){var e=r.Z.extend({},this.mag.model.toJSON());e.user=this.mag.user,document.title=o.getFinalSEO(this.mag.currentPage,e,{customDomain:!!RM.common.isDomainViewer}).title}},trackPage:function(){RM.screenshot||r.Z.defer(r.Z.bind((function(){this.analytics&&this.analytics.trackPage()}),this))},go:function(e,t){if(e=e||1,t.isPageNum)return this.mag.showPage(e,t);var i=this.mag.getPageByPath(e)||{};this.mag.showPage(i.num||e,t)},goBack:function(){var e=this.internalHistory[this.internalHistory.length-2];e&&(e&&this.go(e,{skipInternalHistory:!0}),this.internalHistory.pop())},setUrlString:function(e){if(!this.noUrlRewrite&&(e=e||{},!RM.screenshot)){var t,i=this.mag.currentPage;if(t=RM.common.isDomainViewer&&!RM.common.customDomainProfile||RM.common.isDownloadedSource?"":RM.common.customDomainProfile?this.getMagUri(this.mag):this.username?this.mag.user.uri+"/"+(this.mag.uri||this.mag.num_id)+"/":this.isPreview?this.mag.num_id+"/":this.getMagUri(this.mag),this.isPreview&&(t+="preview/"),i&&"1"!=i.num&&(t+=(i.pagePath||i.uri||i.num.toString())+"/"),e.skipInternalHistory?RM.analytics&&RM.analytics.sendEvent("Back Link",t):this.internalHistory.push(i.num.toString()),RM.common.homepageRewrite||this.trackPage(),t!==s().history.getFragment()){var a=(parseInt(r.Z.last(s().history.getFragment(),"/"))||1)==i.num||e.replace;RM.common.isDownloadedSource&&"/"!==r.Z.last(t)&&(t+="/"),RM.common.homepageRewrite||this.navigate(t,{replace:a})}}},getPreviousFragment:function(){return this.internalHistory[this.internalHistory.length-2]},getMagUri:function(e){return RM.common.customDomainProfile?(e.uri||e.num_id)+"/":RM.common.isDomainViewer?"":r.Z.isEmpty(e.user)?e.num_id+"/":e.user.uri+"/"+(e.uri||e.num_id)+"/"},getUserPermissions:function(){return this.userPermissions||[]},onError:function(){this.mag&&this.go(1,{animation:!1})},createLoginViewForIframe:function(e,t,n){var s=this;i.e(61).then(i.bind(i,1507)).then((function(i){new(0,i.default)({useNavigate:!1,$node:(0,a.ZP)(e),router:s,joinCallback:t,errorMessages:n}).render()}))},createMagFromTemplate:(P=p(regeneratorRuntime.mark((function e(t,a){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.e(59).then(i.bind(i,1509));case 2:new(0,e.sent.default)({router:this,me:this.me,tp:t,templateID:a});case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return P.apply(this,arguments)}),destroy:function(){this.cachedMag&&this.cachedMag.destroy(),this.magPasswordView&&this.magPasswordView.remove(),this.magSuspendedView&&this.magSuspendedView.remove()},requestMagPassword:(M=p(regeneratorRuntime.mark((function e(t,n,s,r){var o,m;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.magPasswordView){e.next=6;break}return e.next=3,i.e(56).then(i.bind(i,1554));case 3:o=e.sent,m=o.default,this.magPasswordView=new m({router:this,$parent:(0,a.ZP)("#mags"),pageUri:s,isPageNum:r});case 6:this.magPasswordView.render({mag:n,mag_url:t});case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,i,a){return M.apply(this,arguments)}),showSuspended:(v=p(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.e(63).then(i.bind(i,1459));case 2:t=e.sent,new(0,t.default)({type:"mag-suspended",$container:(0,a.ZP)("#service-pages")}).render();case 6:case"end":return e.stop()}}),e)}))),function(){return v.apply(this,arguments)}),notFound:function(){r.Z.defer(p(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.e(63).then(i.bind(i,1459));case 2:t=e.sent,n=t.default,new n({type:"404",$container:(0,a.ZP)("#service-pages")}).render();case 6:case"end":return e.stop()}}),e)}))))}});t.default=y}}]);